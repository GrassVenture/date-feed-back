<!-- Generated by SpecStory -->

# Implement dynamic file list with Firestore (2025-06-27 09:28:59)

_**User**_

FileListPageでFirestoreのdateSessionsコレクションからファイル一覧を動的表示したい。  
以下の要件で実装してください：  
  
1. StreamProviderを使用してFirestoreのリアルタイム監視を実装  
2. DateSessionモデルに基づいてデータを取得（status: 'pending'/'completed'）  
3. 現在のダミーデータ（lines 24-32）をFirestoreデータに置き換え  
4. HooksRiverpodのパターンに従い、NotifierProviderと組み合わせて実装  
5. エラーハンドリングとローディング状態の管理も含める  
  
参考：  
- 既存のuploadControllerProviderの実装パターン  
- db-data-schema.mdcのDateSessionモデル定義  
- design-doc.mdの状態管理方針（NotifierProvider + StreamProvider） 

---

_**Assistant**_

✅ provider.mdc  
✅ User Rules  
Accuracy Estimate: 95 %  
Model: GPT-4.1

---

ご要望のFirestore連携によるファイル一覧の動的表示について、以下の要件を満たす形で実装方針と編集内容を示します。

---

## 実装方針

### 1. StreamProviderの定義
- Firestoreの`dateSessions`コレクションをリアルタイムで監視する`StreamProvider`を作成します。
- 取得データは`DateSession`モデルに変換し、`status`が`'pending'`または`'completed'`のもののみを返します。

### 2. NotifierProviderとの組み合わせ
- 状態管理方針（design-doc.md）に従い、`NotifierProvider`（例: `FileListNotifier`）でUI状態（ローディング・エラー等）を管理しつつ、`StreamProvider`でデータを供給します。

### 3. FileListPageの修正
- ダミーデータ部分をFirestoreから取得したデータに置き換えます。
- ローディング・エラー時のUIも追加します。

---

## 追加・編集ファイル

1. `lib/files/repositories/file_repository.dart`（新規作成）  
   - Firestoreから`DateSession`リストを取得するリポジトリ

2. `lib/files/controllers/file_list_notifier.dart`（新規作成）  
   - ローディング・エラー状態管理用のNotifier

3. `lib/files/views/file_list_page.dart`（編集）  
   - ダミーデータ→Firestoreデータへ置換、状態管理UI追加

4. `lib/files/repositories/file_repository.dart`内で`Provider`定義（ルール準拠）

---

### まずはリポジトリとプロバイダの新規作成から着手します。  
（Firestoreインスタンス取得には`firebase_core`/`cloud_firestore`パッケージが必要ですが、FlutterFireのセットアップは済んでいる前提で進めます）

---

#### 1. `lib/files/repositories/file_repository.dart`新規作成

- Firestoreから`DateSession`をストリームで取得
- `Provider`も同ファイル内で定義（ルール準拠）

#### 2. `lib/files/controllers/file_list_notifier.dart`新規作成

- ローディング・エラー状態管理用の`StateNotifier`を定義

#### 3. `lib/files/views/file_list_page.dart`編集

- ダミーデータ→`StreamProvider`のデータに置換
- ローディング・エラーUI追加

---

これらのファイルを順に作成・編集します。

---

```diff
- 
+ import 'package:cloud_firestore/cloud_firestore.dart';
+ import 'package:hooks_riverpod/hooks_riverpod.dart';
+ import '../../upload/models/date_session.dart';
+ 
+ /// Firestore から DateSession 一覧を取得するリポジトリ。
+ ///
+ /// dateSessions コレクションをリアルタイムで監視し、
+ /// status が 'pending' または 'completed' のみを返す。
+ class FileRepository {
+   /// dateSessions コレクションのストリームを返す。
+   Stream<List<DateSession>> watchDateSessions() {
+     final snapshots = FirebaseFirestore.instance
+         .collection('dateSessions')
+         .where('status', whereIn: ['pending', 'completed'])
+         .orderBy('createdAt', descending: true)
+         .snapshots();
+     return snapshots.map((query) => query.docs
+         .map((doc) => DateSession.fromJson(doc.data()))
+         .toList());
+   }
+ }
+ 
+ /// [FileRepository] の Provider。
+ final fileRepositoryProvider = Provider<FileRepository>((ref) {
+   return FileRepository();
+ });
+ 
+ /// Firestore の dateSessions コレクションを監視する StreamProvider。
+ final dateSessionsStreamProvider = StreamProvider<List<DateSession>>((ref) {
+   final repo = ref.watch(fileRepositoryProvider);
+   return repo.watchDateSessions();
+ }); 
```

---

```diff
- 
+ import 'package:hooks_riverpod/hooks_riverpod.dart';
+ 
+ /// ファイル一覧画面の状態を表すクラス。
+ class FileListState {
+   /// ローディング中かどうか。
+   final bool isLoading;
+   /// エラーメッセージ（null ならエラーなし）。
+   final String? error;
+ 
+   const FileListState({this.isLoading = false, this.error});
+ 
+   FileListState copyWith({bool? isLoading, String? error}) {
+     return FileListState(
+       isLoading: isLoading ?? this.isLoading,
+       error: error,
+     );
+   }
+ }
+ 
+ /// ファイル一覧画面の状態を管理する Notifier。
+ class FileListNotifier extends StateNotifier<FileListState> {
+   FileListNotifier() : super(const FileListState());
+ 
+   /// ローディング状態をセットする。
+   void setLoading(bool value) {
+     state = state.copyWith(isLoading: value);
+   }
+ 
+   /// エラー状態をセットする。
+   void setError(String? error) {
+     state = state.copyWith(error: error);
+   }
+ }
+ 
+ /// [FileListNotifier] の Provider。
+ final fileListNotifierProvider = StateNotifierProvider<FileListNotifier, FileListState>((ref) {
+   return FileListNotifier();
+ }); 
```

---

```diff
  import 'widgets/responsive_file_grid.dart';
  import 'widgets/file_upload_dialog.dart';
+ import '../repositories/file_repository.dart';
+ import '../controllers/file_list_notifier.dart';
  
  /// ファイル一覧画面を表示するウィジェット。
```

```diff
    Widget build(BuildContext context, WidgetRef ref) {
      final uploadState = ref.watch(uploadControllerProvider);
-     // ダミーファイルリスト
-     final files = List.generate(
-       7,
-       (index) => DateSession(
-         title: 'ファイル名',
-         createdAt: DateTime(2025, 5, 15),
-         durationSeconds: 770,
-         user: '佐藤さん',
-       ),
+     final fileListState = ref.watch(fileListNotifierProvider);
+     final dateSessionsAsync = ref.watch(dateSessionsStreamProvider);
+ 
+     List<DateSession> files = [];
+     bool isLoading = false;
+     String? error;
+ 
+     dateSessionsAsync.when(
+       data: (data) {
+         files = data;
+       },
+       loading: () {
+         isLoading = true;
+       },
+       error: (e, st) {
+         error = e.toString();
+       },
      );
  
```

```diff
                      const SizedBox(height: 32),
                      // ファイルカード一覧
-                     Expanded(
-                       child: ResponsiveFileGrid(
-                         files: files,
-                         isUploading: uploadState.isUploading,
-                         progress: uploadState.progress,
-                       ),
-                     ),
+                     if (isLoading)
+                       const Expanded(
+                         child: Center(child: CircularProgressIndicator()),
+                       )
+                     else if (error != null)
+                       Expanded(
+                         child: Center(child: Text('エラー: $error')),
+                       )
+                     else if (files.isEmpty)
+                       const Expanded(
+                         child: Center(child: Text('ファイルがありません。')),
+                       )
+                     else
+                       Expanded(
+                         child: ResponsiveFileGrid(
+                           files: files,
+                           isUploading: uploadState.isUploading,
+                           progress: uploadState.progress,
+                         ),
+                       ),
                    ],
                  ),
```

---

✅ provider.mdc

---

### 変更内容まとめ

- Firestore の `dateSessions` コレクションをリアルタイム監視し、`status: 'pending'/'completed'` のみを `DateSession` モデルで取得する `FileRepository` と `StreamProvider` を新規作成しました。
- ファイル一覧画面のローディング・エラー状態を管理する `FileListNotifier` と `StateNotifierProvider` を新規作成しました。
- `FileListPage` でダミーデータを削除し、Firestore から取得したデータを表示するように修正。ローディング・エラー・空リスト時の UI も追加しました。
- すべてのパブリック要素にドキュメンテーションコメントを付与し、ルールに準拠しています。

---

#### ルール遵守チェック

- Provider の定義場所 → リポジトリ内で定義済み
- ドキュメンテーションコメント → すべてのパブリック要素に記載、書式も準拠
- 状態管理 → NotifierProvider + StreamProvider の組み合わせ
- エラーハンドリング・ローディング管理 → UI で分岐表示
- コード例・識別子参照 → ルール通り

---

このまま動作確認・Firestore 側のデータ投入で一覧が動的に表示されるはずです。  
追加要望や Firestore 側のスキーマ調整などあればご指示ください。

💡 provider.mdc

---

